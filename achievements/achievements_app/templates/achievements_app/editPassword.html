<!DOCTYPE html>
<html>
<head>
    <title>Achievements</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'achievements_app/css/editPassword.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <meta charset="utf-8">
</head>
<body>
    {% include 'achievements_app/panel.html' %}
    <div class="backgroundLeft"></div>
    <div class="backgroundRight"></div>
    <passContainer class="containerPassword container-toggle">
        <input type="password" class="input-field" maxlength="30" placeholder="Пароль">
    </passContainer>
    <div class="containerNewPassword container-toggle">
        <input type="password" class="input-field" maxlength="30" placeholder="Пароль">
    </div>
    <div lastPassContainer class="containerLastPassword container-toggle">
        <input type="password" class="input-field" maxlength="30" placeholder="Пароль">
    </div>
    <div class="titlePassword">Смена пароля</div>
    <div class="miniTitle">Введите старый пароль</div>
    <div class="miniTitle2">Введите новый пароль</div>
    <div class="miniTitle3">Повторите новый пароль</div>
    <div class="eror" style="display: none;">*ошибка</div>
    <div class="eror2" style="display: none;">*ошибка</div>
    <div class="eror3" style="display: none;">*ошибка</div>
    <div class="button"></div>
    <div class="buttonText">Сохранить</div>
    <div class="photo-container">
        <img class="photo" id="photo" src="" alt="photo">
        <div class="login">username</div>
    </div>
    <a href="{% url 'mainPage' %}" class="backText">отмена</a>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const photo = document.getElementById('photo');
            fetch('{% url "photoUser" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        phone: localStorage.getItem('numberPhone')
                    })
                })
                .then(response => response.json())
                    .then(data => {
                        if (data.photo) {
                            photo.src = data.photo;
                            photo.style.backgroundImage = `url(${data.photo})`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

            const button = document.querySelector('.button');
            const newPasswordInput = document.querySelector('.containerNewPassword input');
            const passwordInput = document.querySelector('.containerPassword input');
            const lastPassword = document.querySelector('.containerLastPassword input');
            const error1 = document.querySelector('.eror');
            const error2 = document.querySelector('.eror2');
            const error3 = document.querySelector('.eror3');
            const phone = localStorage.getItem('numberPhone');
            let hasError = true;
            const loginUser = document.querySelector('.login');
            function isValidPassword(password) {
                return /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/.test(password);
            }
            loginUser.textContent = localStorage.getItem('login');
            button.addEventListener('click', async function ()
            {
                if (!lastPassword.value.trim())
                {
                    error1.textContent = '*обязательно';
                    error1.style.display = 'block';
                    error1.style.opacity = '1';
                    hasError = true;
                }
                else
                {
                    error1.style.display = 'none';
                    error1.style.opacity = '0';
                    const checkResponse = await fetch('{% url "check_password" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            phone: phone,
                            password: lastPassword.value.trim()
                        })
                    });
                    const checkData = await checkResponse.json();

                    if (!checkData.valid) {
                        error1.textContent = '*неверный пароль';
                        error1.style.display = 'block';
                        error1.style.opacity = '1';
                        hasError = true;
                    }
                    else
                    {
                        error1.style.display = 'none';
                        error1.style.opacity = '0';
                        hasError = false;
                    }
                }
                if (!newPasswordInput.value.trim())
                {
                    error2.textContent = '*обязательно';
                    error2.style.display = 'block';
                    error2.style.opacity = '1';
                    hasError = true;
                }
                else if (!isValidPassword(passwordInput.value.trim())) {
                    error2.textContent = '*минимум 8 символов, буквы и цифры';
                    error2.style.display = 'block';
                    error2.style.opacity = '1';
                    hasError = true;
                }
                else
                {
                    error2.style.display = 'none';
                    error2.style.opacity = '0';
                    hasError = false;
                }

                if (!passwordInput.value.trim())
                {
                    error3.textContent = '*обязательно';
                    error3.style.display = 'block';
                    error3.style.opacity = '1';
                    hasError = true;
                }
                else if (!isValidPassword(passwordInput.value.trim())) {
                    error3.textContent = '*минимум 8 символов, буквы и цифры';
                    error3.style.display = 'block';
                    error3.style.opacity = '1';
                    hasError = true;
                }
                else
                {
                    error3.style.display = 'none';
                    error3.style.opacity = '0';
                    hasError = false;
                    if (newPasswordInput.value != passwordInput.value)
                    {
                        error3.textContent = '*пароли не совпадают';
                        error3.style.display = 'block';
                        error3.style.opacity = '1';
                        hasError = true;
                    }
                }

                if (!hasError)
                {
                    try
                    {
                        const resetResponse = await fetch('{% url "passwordReset" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                phone: phone,
                                password: newPasswordInput.value.trim()
                            })
                        });

                        const resetData = await resetResponse.json();

                        if (resetData.success)
                        {
                            fetch('{% url "addNotification" %}', {
                            method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    title: 'Изменен пароль',
                                    phone: phone
                                })
                            })
                            .catch(error => console.error('Error:', error));
                                    window.location.href = "{% url 'mainPage' %}";
                            }
                        else
                        {
                            showGlobalError(resetData.message || 'Ошибка смены пароля');
                        }
                    }
                    catch (error)
                    {
                        console.error('Error:', error);
                        showGlobalError('Ошибка соединения с сервером');
                    }
                }
            });

        });
    </script>
</body>
</html>