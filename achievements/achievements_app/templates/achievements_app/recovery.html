<!DOCTYPE html>
<html>
<head>
    <title>Achievements</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'achievements_app/css/recovery.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>
    <div class="background"></div>
    <div class="containerPassword container-toggle">
    <input type="password" class="input-field" maxlength="30" placeholder="Пароль">
    </div>
    <div class="containerRepeatPassword container-toggle">
    <input type="password" class="input-field" maxlength="30" placeholder="Повторите пароль">
    </div>
    <div class="containerNumberPhone container-toggle">
    <input type="text" class="input-field" maxlength="4" placeholder="Код"></div>
    <a href="{% url 'autorization' %}" class="backText" ><</a>
    <div class="title">Восстановление</div>
    <div class="miniTitle">Введите код с номера телефона</div>
    <div class="miniTitle2">Введите новый пароль</div>
    <div class="miniTitle3">Повторите пароль</div>
    <div class="eror" style="display: none;">*ошибка</div>
    <div class="eror2" style="display: none;">*ошибка</div>
    <div class="eror3" style="display: none;">*ошибка</div>
    <div class="button"></div>
    <div class="buttonSmall"></div>
    <div class="buttonSmallText">код</div>
    <div class="buttonText">Восстановление</div>
    <div class="emailUse">использовать почту</div>
    <input type="hidden" id="recovery_login" name="login">

     <script>
        document.addEventListener('DOMContentLoaded', function() {
        const button = document.querySelector('.button');
        const codeInput = document.querySelector('.containerNumberPhone input');
        const passwordInput = document.querySelector('.containerPassword input');
        const repeatPasswordInput = document.querySelector('.containerRepeatPassword input');
        const error1 = document.querySelector('.eror');
        const error2 = document.querySelector('.eror2');
        const error3 = document.querySelector('.eror3');
        const buttonSmall = document.querySelector('.buttonSmall');
        const login = localStorage.getItem('recovery_login');
        let code = Math.floor(Math.random() * (9999 - 1000 + 1)) + 1000;
        buttonSmall.addEventListener('click', function() {
                code = Math.floor(Math.random() * (9999 - 1000 + 1)) + 1000;
                console.log('Сгенерированный код:', code);
        });

        button.addEventListener('click', function() {
            let hasError = true;
             if (!repeatPasswordInput.value.trim()) {
                error3.textContent = '*обязательно';
                error3.style.display = 'block';
                error3.style.opacity = '1';
                hasError = true;
            } else {
                error3.style.display = 'none';
                error3.style.opacity = '0';
                hasError = false
            }
            if (!passwordInput.value.trim()) {
                error2.textContent = '*обязательно';
                error2.style.display = 'block';
                error2.style.opacity = '1';
                hasError = true;
            } else {
                error2.style.display = 'none';
                error2.style.opacity = '0';
                hasError = false;
                 if (passwordInput.value !== repeatPasswordInput.value)
                 {
                    error3.textContent = '*пароли не совпадают';
                    error3.style.display = 'block';
                    error3.style.opacity = '1';
                    hasError = true;
                 }
                else
                {
                    error3.style.display = 'none';
                    error3.style.opacity = '0';
                    hasError = false;
                }
            }
            if (!codeInput.value.trim()) {
                error1.textContent = '*обязательно';
                error1.style.display = 'block';
                error1.style.opacity = '1';
                hasError = true;

            } else {
                error1.style.display = 'none';
                error1.style.opacity = '0';
                hasError = false;
                if (codeInput.value.trim() !== String(code)) {
                    error1.textContent = '*неверный код';
                    error1.style.display = 'block';
                    error1.style.opacity = '1';
                    hasError = true;
                }
                else {
                    error1.style.display = 'none';
                    error1.style.opacity = '0';
                    hasError = false;
                }
            }
            if (hasError) {
                return;
            }
             const postData = {
                login: login,
                password: password
            };

            fetch('{% url "passwordReset" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '{% url "autorization" %}';
                } else {
                    throw new Error(data.error || 'Ошибка сервера');
                }
            })
            .catch(error => {
                showError(error2, error.message || 'Ошибка соединения');
            });
        });


     });
     </script>
</body>
</html>