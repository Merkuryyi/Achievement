<!DOCTYPE html>
<html>
<head>
    <title>Achievements</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'achievements_app/css/panel.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>
    <div class="backgroundPanel"></div>
    <div class="backgroundScores"></div>
    <div class="containerSearch container-toggle">
        <input type="text" class="input-field" maxlength="30" placeholder="Поиск">
    </div>
    <photo class="photoProfileHigh"></photo>
    <buttonSearch class="buttonSearch"></buttonSearch>
    <scoresIcon class="scoresIcon"></scoresIcon>
    <scores class="scores">1</scores>
    <div id="noProfileModal" class="modal" style="display: none;">
        {% include 'achievements_app/noProfile.html' %}
    </div>
    <div id="profileModal" class="modal" style="display: none;">
        {% include 'achievements_app/mainPageProfile.html' %}
    </div>
    <div id="securityModal" class="modal" style="display: none;">
        {% include 'achievements_app/securityProfile.html' %}
    </div>
    <script>

        const buttons = document.querySelector('.buttonSearch');
        const scores = document.querySelector('.scores');
        const photoProfile = document.querySelector('.photoProfileHigh');
        const modal = document.createElement('div');
        modal.className = 'custom-modal';
        document.addEventListener('DOMContentLoaded', function()
        {
            let pageName;
            function openModal() {
                closeAllModals();
                if(pageName == 'initial')
                {
                    if (localStorage.getItem('numberPhone') !== null) {
                    document.getElementById('profileModal').style.display = 'block';
                    }
                    else {
                        document.getElementById('noProfileModal').style.display = 'block';
                    }
                }
                else if (pageName == 'security')
                {
                    document.getElementById('securityModal').style.display = 'block';
                }
            }
            function closeAllModals() {
                const modals = ['profileModal', 'noProfileModal', 'securityModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) modal.style.display = 'none';
                });
            }
            function closeModal() {
                if (pageName == 'initial') {
                    if (localStorage.getItem('numberPhone') !== null) {
                        document.getElementById('profileModal').style.display = 'none';
                    }
                    else {
                        document.getElementById('noProfileModal').style.display = 'none';
                    }
                }
                else if (pageName == 'security')
                {
                    document.getElementById('securityModal').style.display = 'none';
                }

            }
            window.onclick = function(event)
            {
                if (pageName == 'initial') {
                    if (localStorage.getItem('numberPhone') !== null) {
                        document.getElementById('profileModal').style.display = 'none';
                    } else {
                        document.getElementById('noProfileModal').style.display = 'none';
                    }
                }
                else if (pageName == 'security')
                {
                    document.getElementById('securityModal').style.display = 'none';
                }
            }
            window.onclick = function(event) {
                let modal = null;
                if (pageName === 'initial') {
                    modal = localStorage.getItem('numberPhone') !== null
                        ? document.getElementById('profileModal')
                        : document.getElementById('noProfileModal');
                }
                else if (pageName === 'security') {
                    modal = document.getElementById('securityModal');
                }
                if (modal && event.target === modal) {
                    closeModal();
                }
            }
            const userData = {
                phone: localStorage.getItem('numberPhone')
            };
            fetch('{% url "scoreUser" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.score !== undefined) {
                    scores.textContent = data.score;
                } else {
                    showGlobalError(data.error || 'Неизвестная ошибка сервера');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            photoProfile.addEventListener('click', function ()
            {
                pageName = 'initial';
                openModal();
            });

            function redirectToAuth() {
                pageName = 'security';
                openModal();
            }
            iconSecurity.addEventListener('click', redirectToAuth);
            securityText.addEventListener('click', redirectToAuth);
        });
    </script>
</body>
</html>