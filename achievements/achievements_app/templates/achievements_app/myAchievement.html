<!DOCTYPE html>
<html>
<head>
    <title>Achievements</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'achievements_app/css/myAchievement.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>
    {% include 'achievements_app/panel.html' %}
    <div class="background"></div>
    <div class="titleContainerMyAchievements">
        <div class="titleAchievement">Мои достижения:</div>
        <div class="countAchievement">0</div>
        <iconPlus class="iconPlus">
            <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.9297 9.0332H10.957V1.44531C10.957 0.650391 10.3594 0 9.62891 0C8.89844 0 8.30078 0.650391 8.30078 1.44531V9.0332H1.32812C0.597656 9.0332 0 9.68359 0 10.4785C0 11.2734 0.597656 11.9238 1.32812 11.9238H8.30078V19.5117C8.30078 20.3066 8.89844 20.957 9.62891 20.957C10.3594 20.957 10.957 20.3066 10.957 19.5117V11.9238H17.9297C18.6602 11.9238 19.2578 11.2734 19.2578 10.4785C19.2578 9.68359 18.6602 9.0332 17.9297 9.0332Z" fill="#878CCD"/>
            </svg>
        </iconPlus>
    </div>
    <div class="achievements-container" id="achievementsContainer"></div>
    <div class="comment-container" id="commentsContainer"></div>
    <div class="filterForAchievements">
        <div class="filterAchievement">по алфавиту от а до я</div>
        <iconFilterAchievement class="iconAchievement">
            <svg width="45" height="45" viewBox="0 0 45 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M31.8104 17.8447L22.5 27.1551L13.1897 17.8447" stroke="#878CCD" stroke-width="2"
                stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </iconFilterAchievement>
    </div>
    <div class="emptyMyAchievement" style="display: none;">Пусто</div>
<script>
    async function addComment(achievementId, text, parent_id) {
        try {
            const response = await fetch('{% url "addComment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    achievement_id: achievementId,
                    text: text,
                    phone: localStorage.getItem('numberPhone'),
                    parent_id: parent_id || null
                })
            });
        } catch (error) {
            console.error('Fetch error:', error);
            return [];
        }
    }
    async function sendComment(button) {
        const wrapper = button.closest('.input-wrapper');
        const field = wrapper.querySelector('.input-fieldComment');
        const text = field.value.trim();
        const commentContainer = button.closest('.comment-input-container');
        const parentId = commentContainer.dataset.parentId;
        const card = commentContainer.closest('.achievement-item');
        const achievementId = parseInt(card.dataset.achievementId);
        if (!text) return;
        await addComment(achievementId, text, parentId);
        text.value = '';
        field.removeAttribute('data-parent-id');
        field.removeAttribute('data-parent-login');
        field.value = '';
        commentContainer.removeAttribute('data-parent-id');
        commentContainer.removeAttribute('data-parent-login');
        const oldCommentsSection = card.querySelector('.comments-section');
        if (oldCommentsSection) { oldCommentsSection.remove(); }
        const comments = await fetchComment(achievementId);
        const newCommentsSection = await renderCommentsSection(achievementId, comments);
        card.appendChild(newCommentsSection);
    }
    document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('click', function(e) {
            const sendButton = e.target.closest('.send-button');
            if (sendButton){
                sendComment(sendButton);
                return;
            }
            const answerLabel = e.target.closest('.answerComment-label');
            if (answerLabel) {
                const parentLogin = answerLabel.dataset.parentLogin;
                const parentId = answerLabel.dataset.parentId;
                const inputContainer = answerLabel.closest('.comments-section').querySelector('.comment-input-container');
                if (parentLogin && parentId && inputContainer) {
                    inputContainer.dataset.parentId = parentId;
                    inputContainer.dataset.parentLogin = parentLogin;
                    const replyUsername = inputContainer.querySelector('.reply-username');
                    if (replyUsername) { replyUsername.textContent = `@${parentLogin}`;  }
                    const replyTo = inputContainer.querySelector('.reply-to');
                    if (replyTo) { replyTo.style.display = 'flex'; }
                }
            }
        });
    });
    async function toggleComments(icon) {
        const card = icon.closest('.achievement-item');
        if (!card) return;
        const wasExpanded = card.classList.contains('comment-expanded');
        document.querySelectorAll('.achievement-item').forEach(item => {
        item.classList.remove('comment-expanded');
            const commentsSection = item.querySelector('.comments-section');
            if(commentsSection) {
                 document.querySelectorAll('.achievement-item').forEach(item => {
                    item.classList.remove('comment-expanded');
                    item.style.marginBottom = "";
                    const commentsSection = item.querySelector('.comments-section');
                    if(commentsSection) commentsSection.remove();
                });
            }
        });
        const achievementId = parseInt(card.dataset.achievementId);
        const comments = await fetchComment(achievementId);
        const commentsSection = await renderCommentsSection(achievementId, comments);
        if(!wasExpanded) {
            card.appendChild(commentsSection);
            card.classList.add('comment-expanded');
            requestAnimationFrame(() => {
                const commentsHeight = commentsSection.offsetHeight;
                card.style.marginBottom = `${commentsHeight}px`;
            });
        }
    }
    let isFilteredComments = false;
    const unliked = `<svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21.4677 6.30353C21.1264 5.46138 20.6342 4.69823 20.0187 4.05681C19.4028
            3.41347 18.6766 2.90221 17.8796 2.55085C17.0532 2.18506 16.1668 1.99782 15.2719
            2.00002C14.0164 2.00002 12.7915 2.36633 11.727 3.05826C11.4724 3.22378 11.2305
            3.40558 11.0013 3.60366C10.7721 3.40558 10.5301 3.22378 10.2755 3.05826C9.21101 2.36633
            7.9861 2.00002 6.73063 2.00002C5.82659 2.00002 4.95057 2.18453 4.12293 2.55085C3.3233
            2.90359 2.60261 3.41101 1.98379 4.05681C1.36751 4.69751 0.875206 5.46084 0.534783 6.30353C0.180808
            7.17997 0 8.11068 0 9.06853C0 9.9721 0.173168 10.9137 0.516957 11.8715C0.804722 12.672 1.21727
            13.5023 1.74441 14.3407C2.57969 15.6676 3.7282 17.0515 5.15429 18.4543C7.51753 20.7797 9.85784
            22.3861 9.95716 22.4512L10.5607 22.8637C10.8281 23.0455 11.1719 23.0455 11.4393 22.8637L12.0428
            22.4512C12.1421 22.3834 14.4799 20.7797 16.8457 18.4543C18.2718 17.0515 19.4203 15.6676 20.2556
            14.3407C20.7827 13.5023 21.1978 12.672 21.483 11.8715C21.8268 10.9137 22 9.9721 22 9.06853C22.0025
            8.11068 21.8217 7.17997 21.4677 6.30353ZM11.0013 20.7173C11.0013 20.7173 1.93541 14.528 1.93541
            9.06853C1.93541 6.30353 4.08218 4.06223 6.73063 4.06223C8.59219 4.06223 10.2067 5.16932 11.0013
            6.78652C11.7958 5.16932 13.4103 4.06223 15.2719 4.06223C17.9203 4.06223 20.0671 6.30353 20.0671
            9.06853C20.0671 14.528 11.0013 20.7173 11.0013 20.7173Z" fill="#9483B5"/>
        </svg>`;
        const liked = `<svg width="22" height="21" viewBox="0 0 22 21" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21.4677 4.30353C21.1264 3.46138 20.6342 2.69823 20.0187
            2.05681C19.4028 1.41347 18.6766 0.902212 17.8796 0.550847C17.0532
            0.185057 16.1668 -0.0021756 15.2719 1.90724e-05C14.0164 1.90724e-05
            12.7915 0.366333 11.727 1.05826C11.4724 1.22378 11.2305 1.40558 11.0013 1.60366C10.7721
            1.40558 10.5301 1.22378 10.2755 1.05826C9.21101 0.366333 7.9861 1.90724e-05 6.73063 1.90724e-05C5.82659
            1.90724e-05 4.95057 0.184533 4.12293 0.550847C3.3233 0.903594 2.60261 1.41101 1.98379 2.05681C1.36751
            2.69751 0.875206 3.46084 0.534783 4.30353C0.180808 5.17997 0 6.11068 0 7.06853C0
            7.9721 0.173168 8.91366 0.516957 9.87151C0.804722 10.672 1.21727 11.5023 1.74441 12.3407C2.57969
            13.6676 3.7282 15.0515 5.15429 16.4543C7.51753 18.7797 9.85784 20.3861 9.95716 20.4512L10.5607
            20.8636C10.8281 21.0455 11.1719 21.0455 11.4393 20.8636L12.0428 20.4512C12.1421 20.3834 14.4799
            18.7797 16.8457 16.4543C18.2718 15.0515 19.4203 13.6676 20.2556 12.3407C20.7827 11.5023 21.1978
            10.672 21.483 9.87151C21.8268 8.91366 22 7.9721 22 7.06853C22.0025 6.11068 21.8217 5.17997
            21.4677 4.30353Z" fill="#9483B5"/>
        </svg>`;
        const plus = document.querySelector('.iconPlus');
        function createAchievement()
            { window.location.href = "{% url 'createAchievement' %}"; }
            plus.addEventListener('click', createAchievement);
    async function renderCommentsSection(achievementId, comments) {
        const commentsSection = document.createElement('div');
        commentsSection.className = 'comments-section';
        commentsSection.innerHTML = `
            <div class="comment-header">
                <span class="filter">по дате добавления</span>
                <iconFilter class="iconFilter">
                    <svg width="45" height="45" viewBox="0 0 45 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M31.8104 17.8447L22.5 27.1551L13.1897 17.8447" stroke="#878CCD" stroke-width="2"
                        stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </iconFilter>
            </div>
        `;
        const filteredComments = comments.filter(comment => comment.id_achievement === achievementId);
        const commentsList = document.createElement('div');
        commentsList.className = 'comments-list';
        commentsList.addEventListener('click', async function(e) {
            if (e.target.closest('.iconDeleteComment')) {
                const commentBlock = e.target.closest('.comment, .comment-reply');
                const answerLabel = commentBlock.querySelector('.answerComment-label');
                const parentId = answerLabel.dataset.parentId;
                await deleteComment(parentId);
                const card = commentBlock.closest('.achievement-item');
                const commentsContainer = card.querySelector('.comments-section');
                const comments = await fetchComment(achievementId);
                const newCommentsSection = await renderCommentsSection(achievementId, comments);
                commentsContainer.replaceWith(newCommentsSection);
            }
            if(e.target.closest('.iconEditComment')) {
                const commentBlock = e.target.closest('.comment, .comment-reply');
                const answerLabel = commentBlock.querySelector('.answerComment-label');
                const parentId = answerLabel.dataset.parentId;
                toggleEditMode(commentBlock, parentId);
            }
        });
        const hasReplies = filteredComments.some(comment => comment.is_main);
        commentsList.className = `comments-list${hasReplies ? ' comments-listReplay' : ''}`;
        filteredComments.forEach(comment => {
            const replyUserHTML = !comment.is_main && comment.parent_login
                ? `<div class="reply-user-container">
                      <div class="circle"></div>
                      <span class="reply-username">${comment.parent_login}</span>

                   </div>`
                : '';
            const commentHTML = `
                <div class="${comment.is_main ? 'comment' : 'comment-reply'}">
                    <div class="user-info">
                        <div class="avatar">
                            <img src=${comment.photo_comment}"
                             alt="Коммен"
                             class="avatar">
                        </div>
                        <span class="username">${comment.login}</span>
                        ${replyUserHTML}
                        <div class="comment-meta">
                            <span class="edit-label">изм.</span>
                            <span class="comment-date">${new Date(comment.date).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="comment-text" contenteditable="false">${comment.text}</div>
                    <div class="interaction-containerComment">
                        <div class="like-groupComment">
                            <iconLike class="iconLikeComment" data-comment-id="${comment.comment_id}">
                                ${comment.is_liked ? liked : unliked}
                            </iconLike>
                            <div class="countLikeComment">${comment.count_like}</div>
                            <div class="comment-group">
                                <iconComment class="iconCommentAnswer" >
                                    <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_666_1413)">
                                            <path d="M10.2678 11.5C10.2678 11.8268 10.3976 12.1402 10.6286 12.3713C10.8597 12.6023
                                            11.1731 12.7321 11.4999 12.7321C11.8267 12.7321 12.1401 12.6023 12.3712 12.3713C12.6022
                                            12.1402 12.732 11.8268 12.732 11.5C12.732 11.1732 12.6022 10.8598 12.3712
                                            10.6287C12.1401 10.3977 11.8267 10.2679 11.4999 10.2679C11.1731 10.2679 10.8597
                                            10.3977 10.6286 10.6287C10.3976 10.8598 10.2678 11.1732 10.2678 11.5ZM15.4017
                                            11.5C15.4017 11.8268 15.5315 12.1402 15.7626 12.3713C15.9936 12.6023 16.307
                                            12.7321 16.6338 12.7321C16.9606 12.7321 17.274 12.6023 17.5051 12.3713C17.7362
                                            12.1402 17.866 11.8268 17.866 11.5C17.866 11.1732 17.7362 10.8598 17.5051
                                            10.6287C17.274 10.3977 16.9606 10.2679 16.6338 10.2679C16.307 10.2679 15.9936
                                            10.3977 15.7626 10.6287C15.5315 10.8598 15.4017 11.1732 15.4017 11.5ZM5.13383
                                            11.5C5.13383 11.8268 5.26365 12.1402 5.49472 12.3713C5.72579 12.6023 6.03919 12.7321
                                            6.36597 12.7321C6.69276 12.7321 7.00616 12.6023 7.23723 12.3713C7.4683 12.1402
                                            7.59812 11.8268 7.59812 11.5C7.59812 11.1732 7.4683 10.8598 7.23723 10.6287C7.00616
                                            10.3977 6.69276 10.2679 6.36597 10.2679C6.03919 10.2679 5.72579 10.3977 5.49472
                                            10.6287C5.26365 10.8598 5.13383 11.1732 5.13383 11.5ZM22.1066 7.04375C21.5265
                                            5.66529 20.6948 4.42801 19.6346 3.36529C18.5819 2.30872 17.3321 1.46887 15.9562
                                            0.893304C14.5443 0.300335 13.0452 0 11.4999 0H11.4486C9.89298 0.00770089 8.38618
                                            0.315737 6.96921 0.92154C5.60502 1.50301 4.36698 2.34435 3.32412 3.39866C2.27423
                                            4.45882 1.45024 5.69096 0.88037 7.06429C0.289969 8.48638 -0.0077994 9.99833
                                            -9.85098e-05 11.5539C0.00861184 13.3366 0.43036 15.093 1.23204 16.6853V20.5871C1.23204
                                            20.9002 1.35645 21.2006 1.57789 21.422C1.79934 21.6435 2.09968 21.7679 2.41285
                                            21.7679H6.3172C7.90947 22.5695 9.66588 22.9913 11.4486 23H11.5025C13.0401 23
                                            14.5315 22.7022 15.9356 22.1195C17.3046 21.5508 18.5497 20.7208 19.6012
                                            19.6758C20.6614 18.6259 21.4957 17.3989 22.0784 16.0307C22.6842 14.6137
                                            22.9922 13.1069 22.9999 11.5513C23.0076 9.98806 22.7047 8.47098 22.1066
                                            7.04375ZM18.2279 18.2871C16.4285 20.0685 14.0412 21.0491 11.4999
                                            21.0491H11.4563C9.90838 21.0414 8.37077 20.6564 7.01285 19.9325L6.79722
                                            19.817H3.18294V16.2027L3.06742 15.9871C2.34354 14.6291 1.9585 13.0915
                                            1.95079 11.5436C1.94053 8.98438 2.91854 6.5817 4.71285 4.77199C6.50459
                                            2.96228 8.89957 1.96116 11.4588 1.95089H11.5025C12.786 1.95089 14.0309 2.19989
                                            15.204 2.69275C16.3489 3.17277 17.3757 3.86328 18.2587 4.74632C19.1392 5.62679
                                            19.8323 6.65614 20.3123 7.801C20.8103 8.98694 21.0593 10.2448 21.0541 11.5436C21.0387
                                            14.1003 20.0351 16.4953 18.2279 18.2871Z" fill="#9483B5"/>
                                        </g>
                                        <defs>
                                            <clipPath id="clip0_666_1413">
                                                <rect width="23" height="23" fill="white"/>
                                            </clipPath>
                                        </defs>
                                    </svg>
                                </iconComment>
                            <div class="countCommentAnswer">${comment.count_comments}</div>
                        </div>
                    </div>
                    <div class="answerComment-label"
                         data-parent-login="${comment.login}"
                         data-parent-id="${comment.comment_id}">
                         ответить
                    </div>
                ${comment.login === localStorage.getItem('login') ?`
                    <iconEdit class="iconEditComment">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2
                            20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391
                            21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="#878CCD" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18.5 2.50023C18.8978 2.1024 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022
                             2.1024 21.5 2.50023C21.8978 2.89805 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284
                             21.8978 5.1024 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z"
                              stroke="#878CCD" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </iconEdit>
                    <iconTrash class="iconDeleteComment">
                        <svg width="35" height="37" viewBox="0 0 35 37" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.20234 10.516H9.37373L10.3845 29.3408C10.3947 29.5294 10.4728
                                29.7068 10.6026 29.8365C10.7325 29.9662 10.9044 30.0386 11.0831 30.0386H24.3362C24.515
                                30.0386 24.6871 29.9661 24.817 29.8362C24.9469 29.7063 25.0248 29.5288 25.0348
                                29.3401L26.0295 10.516H28.2023C28.388 10.516 28.566 10.438 28.6973 10.2992C28.8286
                                10.1604 28.9023 9.97222 28.9023 9.77596C28.9023 9.5797 28.8286 9.39147 28.6973
                                9.2527C28.566 9.11392 28.388 9.03596 28.2023 9.03596H25.5836C25.5451 9.03596 25.5115 9.05298 25.4744
                                9.0589C25.438 9.05298 25.4044 9.03596 25.3673 9.03596H21.6951V7.09938C21.6951 6.90311 21.6214
                                6.71489 21.4901 6.57612C21.3588 6.43734 21.1808 6.35938 20.9951 6.35938H14.4088C14.2232
                                6.35938 14.0451 6.43734 13.9139 6.57612C13.7826 6.71489 13.7088 6.90311 13.7088
                                7.09938V9.03596H10.0352C10.003 9.03596 9.97434 9.0515 9.94284 9.05594C9.91064
                                9.05076 9.88194 9.03596 9.84834 9.03596H7.20304C7.11111 9.03591 7.02008 9.055 6.93513
                                9.09214C6.85018 9.12929 6.77299 9.18375 6.70796 9.25243C6.64292 9.32112 6.59132 9.40267
                                6.5561 9.49243C6.52088 9.58219 6.50273 9.67841 6.50269 9.77559C6.50264 9.87276
                                6.5207 9.969 6.55584 10.0588C6.59097 10.1486 6.64249 10.2302 6.70746
                                10.299C6.77243 10.3677 6.84957 10.4223 6.93448 10.4595C7.01939 10.4967
                                7.11041 10.5159 7.20234 10.516ZM15.1088 7.83938H20.2951V9.03596H15.1088V7.83938ZM24.6274
                                10.516L23.674 28.5594H11.7446L10.7758 10.516H24.6274Z" fill="#878CCD"/>
                                <path d="M14.236 27.1717L14.2766 27.171C14.3684 27.1655 14.4582 27.141
                                14.541 27.0988C14.6238 27.0565 14.6979 26.9975 14.759 26.925C14.8202 26.8525
                                14.8673 26.7679 14.8975 26.6762C14.9278 26.5844 14.9406 26.4873 14.9353 26.3903L14.1989
                                12.6744C14.1863 12.4793 14.102 12.2971 13.964 12.1668C13.826 12.0366 13.6452 11.9686 13.4604
                                11.9773C13.3686 11.9828 13.2788 12.0073 13.196 12.0496C13.1132 12.0918 13.0391 12.1508 12.978
                                12.2233C12.9168 12.2958 12.8697 12.3804 12.8395 12.4721C12.8092 12.5639 12.7964 12.661 12.8017
                                12.758L13.5381 26.4739C13.5483 26.6624 13.6262 26.8396 13.756 26.9694C13.8857 27.0991 14.0574
                                27.1715 14.236 27.1717Z" fill="#878CCD"/>
                                <path d="M21.1029 27.171L21.1435 27.1718C21.3221 27.1715 21.4939 27.0991 21.6236 26.9694C21.7533
                                26.8397 21.8313 26.6624 21.8414 26.4739L22.5778 12.758C22.5884 12.5622 22.5249 12.3699 22.4014
                                12.2236C22.2778 12.0772 22.1044 11.9886 21.9191 11.9773C21.7343 11.9684 21.5534 12.0363 21.4154
                                12.1666C21.2773 12.2969 21.1931 12.4792 21.1806 12.6744L20.4442 26.3903C20.4337 26.5862 20.4972
                                26.7784 20.6207 26.9248C20.7442 27.0712 20.9177 27.1598 21.1029 27.171Z" fill="#878CCD"/>
                                <path d="M17.7022 27.1725C17.8878 27.1725 18.0659 27.0945 18.1972 26.9557C18.3284 26.8169
                                18.4022 26.6287 18.4022 26.4325V12.7166C18.4022 12.5203 18.3284 12.3321 18.1972
                                12.1933C18.0659 12.0545 17.8878 11.9766 17.7022 11.9766C17.5165 11.9766 17.3385
                                12.0545 17.2072 12.1933C17.0759 12.3321 17.0022 12.5203 17.0022 12.7166V26.4325C17.0022
                                26.6287 17.0759 26.8169 17.2072 26.9557C17.3385 27.0945 17.5165 27.1725 17.7022
                                27.1725Z" fill="#878CCD"/>
                        </svg>
                    </iconTrash>` : ''}
            `;
                commentsList.insertAdjacentHTML('beforeend', commentHTML);
        });
        const inputContainer = document.createElement('div');
        inputContainer.innerHTML = `
           <div class="comment-input-container">
               <div class="reply-to">
                    Ответ <span class="reply-username"></span>
                    <button class="cancel-reply">×</button>
               </div>
               <div class="comment-input" maxlength="150">
                    <div class="input-wrapper">
                        <textarea class="input-fieldComment" maxlength="150"
                             contenteditable="true"
                             placeholder="Напишите комментарий"></textarea>
                        <div class="send-container">
                            <div class="send-background"></div>
                            <button class="send-button" >
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 6L9 17L4 12" stroke="#878CCD" stroke-width="2"
                                          stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
               </div>
           </div>
        `;
        const replyTo = inputContainer.querySelector('.reply-to');
        const cancelButton = inputContainer.querySelector('.cancel-reply');
        const replyUsername = inputContainer.querySelector('.reply-username');

        cancelButton.addEventListener('click', () => {
            replyTo.style.display = 'none';
            inputContainer.dataset.parentId = '';
            inputContainer.dataset.parentLogin = '';
        });
        commentsList.querySelectorAll('.answerComment-label').forEach(label => {
            label.addEventListener('click', function() {
                const parentLogin = this.dataset.parentLogin;
                const parentId = this.dataset.parentId;

                replyTo.style.display = 'flex';
                replyUsername.textContent = `@${parentLogin}`;
                inputContainer.dataset.parentId = parentId;
                inputContainer.dataset.parentLogin = parentLogin;
            });
        });
        const iconFilter = commentsSection.querySelector('.iconFilter');
        iconFilter.addEventListener('click', async function() {
            isFilteredComments = !isFilteredComments;
            this.classList.toggle('rotated');

            await new Promise(resolve => {
                this.addEventListener('transitionend', resolve, { once: true });
                setTimeout(resolve, 350);
            });
            const updatedComments = await fetchComment(achievementId, isFilteredComments);
            const newSection = await renderCommentsSection(achievementId, updatedComments);
            commentsSection.replaceWith(newSection);
            const newIconFilter = newSection.querySelector('.iconFilter');
            if (isFilteredComments) {
                newIconFilter.classList.add('rotated');
            }
        });
        commentsSection.appendChild(inputContainer);
        commentsSection.appendChild(commentsList);
        await initLikes(commentsSection);

        return commentsSection;
    }
    async function deleteComment (comment_id)
    {
        try {
            await fetch('{% url "deleteComment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    comment_id: comment_id
                })
            });
        }
        catch (error) {
            console.error('Error', error)
        }
    }

    async function initLikes(commentsSection) {
        const iconLikes = commentsSection.querySelectorAll('.iconLikeComment');
        for (const iconLike of iconLikes) {
            const comment_id = iconLike.dataset.commentId;
            const countLike = iconLike.parentElement.querySelector('.countLikeComment');
            let isLiked = await checkLikeComment(comment_id);
            iconLike.isLiked = isLiked;

            iconLike.addEventListener('click', async () => {
                try {
                    if (!iconLike.isLiked)
                    {
                        await newLikeComment(comment_id);
                        iconLike.isLiked = true;
                        iconLike.innerHTML = liked;
                        countLike.textContent = parseInt(countLike.textContent) + 1;
                    } else
                    {
                        await deleteLikeComment(comment_id);
                        iconLike.isLiked = false;
                        iconLike.innerHTML = unliked;
                        countLike.textContent = parseInt(countLike.textContent) - 1;
                    }
                } catch (error) {
                    console.error('Ошибка при обновлении лайка:', error);
                }
            });
            iconLike.innerHTML = isLiked ? liked : unliked;
        }
    }
    async function fetchComment(achievementId) {
        try {
            const response = await fetch('{% url "returnComments" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    achievement_id: achievementId,
                    isFiltered: isFilteredComments ? 'true' : 'false'
                })
            });
            if (!response.ok) throw new Error('Network error');

            const data = await response.json();
            return data.comments.map(comment => ({
                comment_id: comment.comment_id,
                user_id: comment.user_id,
                login: comment.login,
                photo_comment: comment.photo_comment,
                parent_login: comment.parent_login,
                id_achievement: comment.achievement_id,
                text: comment.text,
                date: comment.latest_day,
                is_main: comment.is_main,
                count_comments: comment.count_comments,
                count_like: comment.count_like
            }));
        }
        catch (error) {
            console.error('Fetch error:', error);
            return [];
        }
    }
    async function newLikeComment(comment_id) {
        try {
            await fetch('{% url "newLikeComment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    phone: localStorage.getItem('numberPhone'),
                    comment_id: comment_id
                })
            });
        }
        catch (error) {
            console.error('Error', error)
        }
    }
    async function deleteLikeComment(comment_id) {
        try {
            await fetch('{% url "deleteLikeComment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    phone: localStorage.getItem('numberPhone'),
                    comment_id: comment_id
                })
            });
        }
        catch (error) {
            console.error('Error', error)
        }
    }
    async function checkLikeComment(comment_id) {
        const response = await fetch('{% url "check_LikeComment" %}',{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                phone: localStorage.getItem('numberPhone'),
                comment_id: comment_id
            })
        })
        const data = await response.json();
        return data.exists;
    }
    async function toggleEditMode(commentBlock, comment_id) {
        const textElement = commentBlock.querySelector('.comment-text');
        const editIcon = commentBlock.querySelector('.iconEditComment');
        const newText = textElement.textContent.trim();

        if (textElement.isContentEditable && newText) {
            textElement.contentEditable = false;
            await fetch('{% url "updateComment" %}',{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    comment_id: comment_id,
                    text: newText
                })
            })
            editIcon.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2
                    20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391
                    21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="#878CCD" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.5 2.50023C18.8978 2.1024 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022
                    2.1024 21.5 2.50023C21.8978 2.89805 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284
                    21.8978 5.1024 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z"
                    stroke="#878CCD" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
        }
        else
        {
            textElement.contentEditable = true;
            textElement.focus();
            editIcon.innerHTML =
            `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 6L9 17L4 12" stroke="#878CCD" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        let isAscending = false;
        const iconFilter = document.querySelector('.iconAchievement');
        document.getElementById('achievementsContainer').addEventListener('click', (e) => {
        const iconComment = e.target.closest('.iconComment');
            if (iconComment) {
                toggleComments(iconComment);
            }
        });
        loadAndRenderAchievements();
        iconFilter.addEventListener('click', function() {
            this.classList.toggle('rotated');
            if (isAscending === false)
            {
                isAscending = true;
                loadAndRenderAchievements();
            }
            else
            {
                isAscending = false;
                loadAndRenderAchievements();
            }
        });
        async function fetchAchievement() {
            try {
                const response = await fetch('{% url "returnMyAchievement" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        isFiltered: isAscending ? 'true' : 'false',
                        login: localStorage.getItem('login')
                    })
                });

                const data = await response.json();
                achievements = (data.achievements || []).map(achievements => ({
                    login: achievements.login,
                    id_achievement: achievements.id_achievement,
                    title: achievements.title,
                    date: achievements.date,
                    photoLink: achievements.photoLink,
                    countComment: achievements.countComment,
                    countLike: achievements.countLike,
                    isVisible: achievements.isVisible
                }));
                return achievements;
            }
            catch (error) {
                console.error('Error', error)
                return [];
            }
        }

        async function newLike(achievement_id) {
            try {
                await fetch('{% url "newLike" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        phone: localStorage.getItem('numberPhone'),
                        achievement_id: achievement_id
                    })
                });
            }
            catch (error) {
                console.error('Error', error)
            }
        }
        async function deleteLike(achievement_id) {
            try {
                await fetch('{% url "deleteLike" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        phone: localStorage.getItem('numberPhone'),
                        achievement_id: achievement_id
                    })
                });
            }
            catch (error) {
                console.error('Error', error)
            }
        }
        async function checkLike(achievement_id) {
            const response = await fetch('{% url "check_Like" %}',{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    phone: localStorage.getItem('numberPhone'),
                    achievement_id: achievement_id
                })
            })
            const data = await response.json();
            return data.exists;
        }
        async function loadAndRenderAchievements() {
            const achievements = await fetchAchievement();
            const emptyTitle = document.querySelector('.emptyMyAchievement');
            if (achievements.length == 0)
            {
                emptyTitle.style.display = 'block';
                emptyTitle.style.opacity = '1';
            }
            else
            {
                emptyTitle.style.display = 'none';
                emptyTitle.style.opacity = '0';
            }
            renderAchievements(achievements);
            return achievements
        }
        const visibleIcon = `<svg width="40" height="37" viewBox="0 0 40 37" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_794_1679)">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M31.455 5.98047L33.3906 7.77034L8.4825 30.8109L6.54687 29.0205L31.455 5.98047Z" fill="#878CCD"/>
        <path d="M29.3009 11.553L27.479 13.2383C29.4734 14.809 31.0615 16.7642 32.0878 18.4749L32.0909 18.4807C29.2328 22.901 24.6978 27.0786 18.974 26.445C17.429 26.2738 15.9878 25.7853 14.6709 25.0864L12.8265 26.7918C15.3934 28.3158 18.3359 29.1228 21.524 28.7239C27.2728 28.0047 31.9734 23.6434 34.9365 18.5212C33.5453 15.9317 31.6421 13.4545 29.3009 11.553ZM25.1571 9.05553C23.5496 8.393 21.8103 8.00334 19.9528 7.97559C19.8496 7.97501 18.6253 8.02878 18.0703 8.11318C17.7221 8.16637 17.3753 8.23286 17.0334 8.31553C11.5803 9.62961 7.54027 13.8939 5.00027 18.287C6.0659 20.2775 7.46152 22.22 9.1259 23.8844L10.8928 22.2501C9.6634 21.0244 8.6384 19.6601 7.84902 18.3367C7.84902 18.3367 8.64277 17.1562 9.24465 16.4151C9.63152 15.9387 10.0384 15.4762 10.4659 15.0305C10.8034 14.679 12.114 13.4851 12.4259 13.2365C14.5184 11.5721 16.9753 10.2661 19.9221 10.2881C21.0634 10.3049 22.1609 10.513 23.2028 10.8633L25.1571 9.05553Z" fill="#878CCD"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M24.342 16.1406L22.8426 17.5269C22.9407 17.8027 22.9945 18.0976 22.9945 18.4034C22.9945 19.9481 21.6389 21.2021 19.9689 21.2021C19.6382 21.2021 19.3195 21.1529 19.0214 21.0616L17.522 22.4485C18.2457 22.8243 19.0807 23.0382 19.9689 23.0382C22.7345 23.0382 24.9795 20.9616 24.9795 18.4034C24.9795 17.5819 24.7476 16.8101 24.342 16.1406ZM20.0614 13.7697C20.0307 13.7691 19.9995 13.7686 19.9689 13.7686C17.2032 13.7686 14.9582 15.8458 14.9582 18.4034C14.9582 18.4323 14.9582 18.4606 14.9589 18.4889L20.0614 13.7697Z" fill="#878CCD"/>
        </g>
        <defs>
        <clipPath id="clip0_794_1679">
        <rect width="40" height="37" fill="white" transform="matrix(-1 0 0 1 40 0)"/>
        </clipPath>
        </defs>
        </svg>
        `;

        const hiddenIcon = `<svg width="40" height="37" viewBox="0 0 40 37" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_794_1716)">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M20.3209 8.05091C26.9296 8.13763 32.3515 13.6339 35.0671 18.3629C35.0671 18.3629 34.1115 20.1719 33.2152 21.3299C32.7815 21.8901 32.3252 22.4358 31.8459 22.9636C31.504 23.3394 31.1509 23.7054 30.7846 24.0609C27.5115 27.2406 22.8109 29.6127 17.8471 28.6917C12.3327 27.6684 7.83461 23.2978 5.13086 18.5971C5.13086 18.5971 6.09086 16.7864 6.99211 15.6301C7.39586 15.1116 7.81961 14.6069 8.26336 14.1172C8.60336 13.742 8.95586 13.376 9.32023 13.0205C12.2121 10.2015 15.9227 8.03126 20.3209 8.05091ZM20.2977 10.3634C16.6165 10.3507 13.5552 12.2521 11.1334 14.6126C10.804 14.9335 10.4865 15.2642 10.179 15.603C9.77461 16.0493 9.38836 16.51 9.02023 16.9824C8.65211 17.4541 8.27461 18.0496 7.97523 18.5554C10.359 22.2606 13.9371 25.6074 18.339 26.4243C22.4409 27.1857 26.269 25.094 28.974 22.4665C29.3046 22.1456 29.624 21.8143 29.9327 21.475C30.3702 20.9934 30.7865 20.4956 31.1821 19.984C31.5484 19.5105 31.9252 18.9139 32.224 18.4074C29.7502 14.5774 25.5177 10.4386 20.2977 10.3634Z" fill="#878CCD"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M20.0985 13.8447C22.8641 13.8447 25.1098 15.9219 25.1098 18.4796C25.1098 21.0378 22.8641 23.1144 20.0985 23.1144C17.3335 23.1144 15.0879 21.0378 15.0879 18.4796C15.0879 15.9219 17.3335 13.8447 20.0985 13.8447ZM20.0985 16.1624C21.4816 16.1624 22.6041 17.2007 22.6041 18.4796C22.6041 19.7589 21.4816 20.7973 20.0985 20.7973C18.716 20.7973 17.5935 19.7589 17.5935 18.4796C17.5935 17.2007 18.716 16.1624 20.0985 16.1624Z" fill="#878CCD"/>
        </g>
        <defs>
        <clipPath id="clip0_794_1716">
        <rect width="40" height="37" fill="white"/>
        </clipPath>
        </defs>
        </svg>
        `;
        function createAchievementCard(data) {
            const item = document.createElement('div');

            item.dataset.achievementId = data.id_achievement;
            item.className = 'achievement-item';
            const visibilityIcon = data.isVisible ? visibleIcon : hiddenIcon;
            item.innerHTML = `
                <div class="achievement-controls">
                <iconisVisible class="iconIsVisibleAchievement">
                  ${visibilityIcon}
                </iconisVisible>
                        <iconDeleteAchievement class="iconDeleteAchievement">
                            <svg width="35" height="37" viewBox="0 0 35 37" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.20258 10.516H9.37398L10.3848 29.3408C10.395 29.5294 10.473 29.7068 10.6029 29.8365C10.7328
                            29.9662 10.9047 30.0386 11.0834 30.0386H24.3365C24.5153 30.0386 24.6873 29.9661 24.8172 29.8362C24.9471 29.7063 25.0251 29.5288
                            25.0351 29.3401L26.0298 10.516H28.2026C28.3882 10.516 28.5663 10.438 28.6976 10.2992C28.8288 10.1604 28.9026 9.97222 28.9026 9.77596C28.9026 9.5797 28.8288 9.39147 28.6976 9.2527C28.5663 9.11392 28.3882 9.03596 28.2026 9.03596H25.5839C25.5454 9.03596 25.5118 9.05298 25.4747 9.0589C25.4383 9.05298 25.4047 9.03596 25.3676 9.03596H21.6954V7.09938C21.6954 6.90311 21.6216 6.71489 21.4904 6.57612C21.3591 6.43734 21.181 6.35938 20.9954 6.35938H14.4091C14.2234 6.35938 14.0454 6.43734 13.9141 6.57612C13.7828 6.71489 13.7091 6.90311 13.7091 7.09938V9.03596H10.0355C10.0033 9.03596 9.97458 9.0515 9.94308 9.05594C9.91088 9.05076 9.88218 9.03596 9.84858 9.03596H7.20328C7.11135 9.03591 7.02032 9.055 6.93537 9.09214C6.85043 9.12929 6.77324 9.18375 6.7082 9.25243C6.64317 9.32112 6.59157 9.40267 6.55635 9.49243C6.52113 9.58219 6.50298 9.67841 6.50293 9.77559C6.50288 9.87276 6.52094 9.969 6.55608 10.0588C6.59122 10.1486 6.64274 10.2302 6.70771 10.299C6.77268 10.3677 6.84982 10.4223 6.93473 10.4595C7.01964 10.4967 7.11065 10.5159 7.20258 10.516ZM15.1091 7.83938H20.2954V9.03596H15.1091V7.83938ZM24.6277 10.516L23.6743 28.5594H11.7449L10.7761 10.516H24.6277Z" fill="#878CCD"/>
                            <path d="M14.2362 27.1717L14.2768 27.171C14.3686 27.1655 14.4584 27.141 14.5412 27.0988C14.624 27.0565 14.6981 26.9975 14.7593 26.925C14.8205 26.8525 14.8675 26.7679 14.8978 26.6762C14.928 26.5844 14.9408 26.4873 14.9355 26.3903L14.1991 12.6744C14.1865 12.4793 14.1022 12.2971 13.9642 12.1668C13.8262 12.0366 13.6455 11.9686 13.4606 11.9773C13.3689 11.9828 13.279 12.0073 13.1963 12.0496C13.1135 12.0918 13.0394 12.1508 12.9782 12.2233C12.917 12.2958 12.87 12.3804 12.8397 12.4721C12.8095 12.5639 12.7966 12.661 12.8019 12.758L13.5383 26.4739C13.5485 26.6624 13.6265 26.8396 13.7562 26.9694C13.8859 27.0991 14.0577 27.1715 14.2362 27.1717Z" fill="#878CCD"/>
                            <path d="M21.1032 27.171L21.1438 27.1718C21.3224 27.1715 21.4941 27.0991 21.6238 26.9694C21.7536 26.8397 21.8315 26.6624 21.8417 26.4739L22.5781 12.758C22.5886 12.5622 22.5251 12.3699 22.4016 12.2236C22.2781 12.0772 22.1046 11.9886 21.9194 11.9773C21.7345 11.9684 21.5537 12.0363 21.4156 12.1666C21.2776 12.2969 21.1933 12.4792 21.1809 12.6744L20.4445 26.3903C20.434 26.5862 20.4975 26.7784 20.621 26.9248C20.7445 27.0712 20.9179 27.1598 21.1032 27.171Z" fill="#878CCD"/>
                            <path d="M17.702 27.1725C17.8876 27.1725 18.0657 27.0945 18.1969 26.9557C18.3282 26.8169 18.402 26.6287 18.402 26.4325V12.7166C18.402 12.5203 18.3282 12.3321 18.1969 12.1933C18.0657 12.0545 17.8876 11.9766 17.702 11.9766C17.5163 11.9766 17.3383 12.0545 17.207 12.1933C17.0757 12.3321 17.002 12.5203 17.002 12.7166V26.4325C17.002 26.6287 17.0757 26.8169 17.207 26.9557C17.3383 27.0945 17.5163 27.1725 17.702 27.1725Z" fill="#878CCD"/>
                            </svg>
                        </iconDeleteAchievement>
                        <iconEditAchievement class="iconEditAchievement">
                            <svg  viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304
                                    2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142
                                    21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="#878CCD" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round"/>
                                <path d="M18.5 2.50023C18.8978 2.1024 19.4374
                                    1.87891 20 1.87891C20.5626 1.87891 21.1022 2.1024 21.5 2.50023C21.8978 2.89805 22.1213 3.43762 22.1213
                                    4.00023C22.1213 4.56284 21.8978 5.1024 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z"
                                    stroke="#878CCD" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </iconEditAchievement>

                   </div>
                <div class="photo-achievement">
                    <img src=${data.photoLink}"
                     alt="Достижение"
                     class="achievement-photo">
                </div>
                <div class="text-container">
                    <div class="login-achievement">${data.login}</div>
                    <div class="name-achievement">${data.title}</div>

                </div>
                <div class="interaction-container">
                <date class="date-achievement">${new Date(data.date).toLocaleDateString()}</date>
                    <div class="like-group">
                         <iconLike class="iconLike"></iconLike>
                        <div class="countLike">${data.countLike}</div>
                    </div>
                    <div class="comment-group">
                        <iconComment class="iconComment">
                            <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_666_1413)">
                                <path d="M10.2678 11.5C10.2678 11.8268 10.3976 12.1402 10.6286 12.3713C10.8597 12.6023
                                    11.1731 12.7321 11.4999 12.7321C11.8267 12.7321 12.1401 12.6023 12.3712 12.3713C12.6022
                                    12.1402 12.732 11.8268 12.732 11.5C12.732 11.1732 12.6022 10.8598 12.3712
                                    10.6287C12.1401 10.3977 11.8267 10.2679 11.4999 10.2679C11.1731 10.2679 10.8597
                                    10.3977 10.6286 10.6287C10.3976 10.8598 10.2678 11.1732 10.2678 11.5ZM15.4017
                                    11.5C15.4017 11.8268 15.5315 12.1402 15.7626 12.3713C15.9936 12.6023 16.307
                                    12.7321 16.6338 12.7321C16.9606 12.7321 17.274 12.6023 17.5051 12.3713C17.7362
                                    12.1402 17.866 11.8268 17.866 11.5C17.866 11.1732 17.7362 10.8598 17.5051
                                    10.6287C17.274 10.3977 16.9606 10.2679 16.6338 10.2679C16.307 10.2679 15.9936
                                    10.3977 15.7626 10.6287C15.5315 10.8598 15.4017 11.1732 15.4017 11.5ZM5.13383
                                    11.5C5.13383 11.8268 5.26365 12.1402 5.49472 12.3713C5.72579 12.6023 6.03919 12.7321
                                    6.36597 12.7321C6.69276 12.7321 7.00616 12.6023 7.23723 12.3713C7.4683 12.1402
                                    7.59812 11.8268 7.59812 11.5C7.59812 11.1732 7.4683 10.8598 7.23723 10.6287C7.00616
                                    10.3977 6.69276 10.2679 6.36597 10.2679C6.03919 10.2679 5.72579 10.3977 5.49472
                                    10.6287C5.26365 10.8598 5.13383 11.1732 5.13383 11.5ZM22.1066 7.04375C21.5265
                                    5.66529 20.6948 4.42801 19.6346 3.36529C18.5819 2.30872 17.3321 1.46887 15.9562
                                    0.893304C14.5443 0.300335 13.0452 0 11.4999 0H11.4486C9.89298 0.00770089 8.38618
                                    0.315737 6.96921 0.92154C5.60502 1.50301 4.36698 2.34435 3.32412 3.39866C2.27423
                                    4.45882 1.45024 5.69096 0.88037 7.06429C0.289969 8.48638 -0.0077994 9.99833
                                    -9.85098e-05 11.5539C0.00861184 13.3366 0.43036 15.093 1.23204 16.6853V20.5871C1.23204
                                    20.9002 1.35645 21.2006 1.57789 21.422C1.79934 21.6435 2.09968 21.7679 2.41285
                                    21.7679H6.3172C7.90947 22.5695 9.66588 22.9913 11.4486 23H11.5025C13.0401 23
                                    14.5315 22.7022 15.9356 22.1195C17.3046 21.5508 18.5497 20.7208 19.6012
                                    19.6758C20.6614 18.6259 21.4957 17.3989 22.0784 16.0307C22.6842 14.6137
                                    22.9922 13.1069 22.9999 11.5513C23.0076 9.98806 22.7047 8.47098 22.1066
                                    7.04375ZM18.2279 18.2871C16.4285 20.0685 14.0412 21.0491 11.4999
                                    21.0491H11.4563C9.90838 21.0414 8.37077 20.6564 7.01285 19.9325L6.79722
                                    19.817H3.18294V16.2027L3.06742 15.9871C2.34354 14.6291 1.9585 13.0915
                                    1.95079 11.5436C1.94053 8.98438 2.91854 6.5817 4.71285 4.77199C6.50459
                                    2.96228 8.89957 1.96116 11.4588 1.95089H11.5025C12.786 1.95089 14.0309 2.19989
                                    15.204 2.69275C16.3489 3.17277 17.3757 3.86328 18.2587 4.74632C19.1392 5.62679
                                    19.8323 6.65614 20.3123 7.801C20.8103 8.98694 21.0593 10.2448 21.0541 11.5436C21.0387
                                    14.1003 20.0351 16.4953 18.2279 18.2871Z" fill="#9483B5"/>
                                </g>
                                <defs>
                                    <clipPath id="clip0_666_1413">
                                        <rect width="23" height="23" fill="white"/>
                                    </clipPath>
                                </defs>
                            </svg>
                        </iconComment>
                        <div class="countComment">${data.countComment}</div>
                    </div>
                `;
            return item;
        }
        async function deleteAchievement(achievement_id)
        {
            await fetch('{% url "deleteAchievement" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        achievement_id: achievement_id
                    })
                });

        }
        async function updateVisibility(achievement_id, newVisibility)
        {
            const response = await fetch('{% url "updateVisibleAchievement" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        achievement_id: achievement_id,
                        visible: newVisibility
                    })
                });
            const result = await response.json();

        }
        async function renderAchievements(achievements) {
            const container = document.getElementById('achievementsContainer');
            container.innerHTML = '';
            for (const achievement of achievements)
            {
                const card = createAchievementCard(achievement);
                    container.appendChild(card);
                    const editIcon = card.querySelector('.iconEditAchievement');
                    const deleteIcon = card.querySelector('.iconDeleteAchievement');
                    const iconIsVisible = card.querySelector('.iconIsVisibleAchievement');
                    editIcon.addEventListener('click', () => {
                        localStorage.setItem('editingAchievementId', achievement.id_achievement);
                        window.location.href = "{% url 'createAchievement' %}";
                    });
                    deleteIcon.addEventListener('click', () => {
                        deleteAchievement(achievement.id_achievement);
                    });
                    iconIsVisible.addEventListener('click', () => {
                        const newVisibility = !achievement.isVisible;
                        const flag = updateVisibility(achievement.id_achievement, newVisibility, iconIsVisible);
                        if (flag)
                        {
                            iconIsVisible.innerHTML = newVisibility ? visibleIcon : hiddenIcon;
                            achievement.isVisible = newVisibility;
                        }
                    });


                    const iconLike = card.querySelector('.iconLike');
                    const countLike = card.querySelector('.countLike');
                    const achievementId = card.dataset.achievementId;
                    let isLiked = await checkLike(achievementId);
                    iconLike.innerHTML = isLiked ? liked : unliked;
                    let isProcessing = false;
                    iconLike.addEventListener('click', async () => {
                        if (isProcessing) return;
                        isProcessing = true;
                        try
                        {
                            if (isLiked)
                            {
                                await deleteLike(achievementId);
                                countLike.textContent = parseInt(countLike.textContent) - 1;
                                iconLike.innerHTML = unliked;
                                isLiked = false;
                            }
                            else
                            {
                                await newLike(achievementId);
                                countLike.textContent = parseInt(countLike.textContent) + 1;
                                iconLike.innerHTML = liked;
                                isLiked = true;
                            }
                        }
                        catch (error)
                        {
                            console.error('Ошибка при обновлении лайка:', error);
                        }
                        finally
                        {
                            setTimeout(() =>
                            {
                                isProcessing = false;
                            }, 300);
                        }
                    });
                }
            }
        });

</script>
</body>
</html>